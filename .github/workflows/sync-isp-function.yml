name: Sync ISP Function

on:
  push:
    paths:
      - 'Module/Panel/IP-info/Moore/IP-1.js'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-function:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Sync ISP function to other files
      run: |
        # ç›´æ¥åœ¨å·¥ä½œæµä¸­æ‰§è¡Œè„šæœ¬ï¼Œä¸åˆ›å»ºé¢å¤–æ–‡ä»¶
        echo "ğŸ”„ Starting sync function job"
        
        SOURCE_FILE="Module/Panel/IP-info/Moore/IP-1.js"
        TARGET_FILES=(
          "Module/Panel/IP-info/Moore/IP-2.js"
          "Module/Panel/IP-info/Moore/IP-3.js"
          "Module/Panel/IP-info/Moore/IP-4.js"
        )

        echo "ğŸ” Source file: $SOURCE_FILE"
        
        # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$SOURCE_FILE" ]; then
          echo "âŒ Error: Source file $SOURCE_FILE does not exist!"
          exit 1
        fi
        
        # ä½¿ç”¨ Node.js æå–å‡½æ•°ï¼Œå¤„ç†æ›´å¤æ‚çš„æƒ…å†µ
        node -e "
          const fs = require('fs');
          const sourceCode = fs.readFileSync('$SOURCE_FILE', 'utf8');
          
          // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å®Œæ•´çš„ cleanIspInfo å‡½æ•°
          const functionRegex = /function\s+cleanIspInfo[\s\S]*?^}/m;
          const match = sourceCode.match(functionRegex);
          
          if (!match) {
            console.error('âŒ Error: cleanIspInfo function not found in source file!');
            process.exit(1);
          }
          
          fs.writeFileSync('/tmp/cleanIspInfo.js', match[0]);
          console.log('âœ… Successfully extracted cleanIspInfo function');
        "
        
        # æ˜¾ç¤ºæå–çš„å‡½æ•°å†…å®¹ä¾›ç¡®è®¤
        echo "ğŸ“ Extracted function:"
        cat /tmp/cleanIspInfo.js
        
        UPDATED_FILES=0
        
        # å¤„ç†ç›®æ ‡æ–‡ä»¶
        for TARGET_FILE in "${TARGET_FILES[@]}"; do
          echo "ğŸ”„ Processing target file: $TARGET_FILE"
          
          # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$TARGET_FILE" ]; then
            echo "âš ï¸ Warning: Target file $TARGET_FILE does not exist, skipping..."
            continue
          fi
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œåœ¨ç³»ç»Ÿä¸´æ—¶ç›®å½•è€Œéé¡¹ç›®ç›®å½•
          TEMP_FILE="/tmp/$(basename ${TARGET_FILE}).tmp"
          
          # ä½¿ç”¨ Node.js æ›¿æ¢å‡½æ•°ï¼Œå¤„ç†æ›´å¤æ‚çš„æƒ…å†µ
          node -e "
            const fs = require('fs');
            const targetCode = fs.readFileSync('$TARGET_FILE', 'utf8');
            const newFunction = fs.readFileSync('/tmp/cleanIspInfo.js', 'utf8');
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢å‡½æ•°
            const functionRegex = /function\s+cleanIspInfo[\s\S]*?^}/m;
            
            if (targetCode.match(functionRegex)) {
              // å¦‚æœæ‰¾åˆ°å‡½æ•°ï¼Œæ›¿æ¢å®ƒ
              const updatedCode = targetCode.replace(functionRegex, newFunction);
              fs.writeFileSync('$TEMP_FILE', updatedCode);
              console.log('âœ… Function replaced');
            } else {
              // å¦‚æœæ²¡æ‰¾åˆ°å‡½æ•°ï¼Œæ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾
              fs.writeFileSync(
                '$TEMP_FILE', 
                targetCode + '\n\n// Added by sync workflow\n' + newFunction
              );
              console.log('âœ… Function appended to file');
            }
          "
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®é™…å˜åŒ–
          if cmp -s "$TARGET_FILE" "$TEMP_FILE"; then
            echo "â„¹ï¸ No changes needed for $TARGET_FILE"
            rm -f "$TEMP_FILE"  # åˆ é™¤ä¸éœ€è¦çš„ä¸´æ—¶æ–‡ä»¶
          else
            mv "$TEMP_FILE" "$TARGET_FILE"
            echo "âœ… Updated $TARGET_FILE"
            UPDATED_FILES=$((UPDATED_FILES + 1))
          fi
        done
        
        echo "ğŸ“Š Summary: Updated $UPDATED_FILES files"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f /tmp/cleanIspInfo.js
        
        # å¦‚æœæœ‰å˜æ›´ï¼Œæäº¤å¹¶æ¨é€
        if [ -n "$(git status --porcelain)" ]; then
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "âœ¨ Sync cleanIspInfo function from IP-1.js to other JS files"
          git push
          echo "ğŸ‰ Changes committed and pushed"
        else
          echo "â„¹ï¸ No changes detected"
        fi

    - name: Clean up
      if: always()
      run: |
        rm -f /tmp/cleanIspInfo.js /tmp/*.tmp
        echo "ğŸ§¹ Cleanup completed"
